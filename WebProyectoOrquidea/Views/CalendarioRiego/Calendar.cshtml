@model WebProyectoOrquidea.Models.CalendarioRiego

@{
    ViewData["Title"] = "Calendario de Riego - OrchidCare";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/site.css">
</head>
<body class="dashboard-background">
    <!--  LOADER   -->
    <div id="loader">
        <div class="loader-icon" style="font-size:70px;">
            🌸
        </div>
    </div>
    <!--  FIN LOADER -->
    <div class="topbar">
        <div>
            <h1>📅 Calendario de Riego de Orquídeas</h1>
        </div>

        <div class="user-info">
            <button onclick="location.href='@Url.Action("Dashboard", "Home")'"
                    style="padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                ← Volver al Menú Principal
            </button>
        </div>
    </div>

    <div class="dashboard">

        <!-- Notificaciones de Riego -->
        <div class="notifications-panel">
            <h2 style="margin-bottom: 20px; color: #764ba2;">🔔 Notificaciones de Riego Activas</h2>
            <div id="wateringNotifications">
                <!-- Notificaciones dinámicas -->
            </div>
        </div>
        <!-- Riegos de Hoy -->
        <div class="calendar-section" style="margin-top: 30px;">
            <h2 style="color: #764ba2; margin-bottom: 20px;">🌊 Riegos de Hoy</h2>
            <div id="todayWatering"></div>
        </div>

        <!-- Formulario para Agregar Riego -->
        <div class="calendar-section" style="margin-top: 30px;">
            <h2 style="color: #764ba2; margin-bottom: 20px;">➕ Programar Nuevo Riego</h2>

            <form asp-controller="CalendarioRiego" asp-action="SaveWateringSchedule" method="post" id="wateringForm">
                @Html.AntiForgeryToken()
                <div class="calendar-form">

                    <div class="form-group">
                        <label asp-for="NombreOrquidea"></label>
                        <input asp-for="NombreOrquidea" class="form-control" required placeholder="Ej: Phalaenopsis #1" />
                    </div>

                    <div class="form-group">
                        <label asp-for="Zona"></label>
                        <select asp-for="Zona" class="form-control" required>
                            <option value="">Seleccione zona</option>
                            <option value="A">Zona A</option>
                            <option value="B">Zona B</option>
                            <option value="C">Zona C</option>
                            <option value="Area de Plantines">Area de Plantines</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label asp-for="DiaRiego"></label>
                        <select asp-for="DiaRiego" type="number" min="1" class="form-control" required>
                            <option value="0">Seleccione el día</option>
                            <option value="1">Lunes</option>
                            <option value="2">Martes</option>
                            <option value="3">Miercoles</option>
                            <option value="4">Jueves</option>
                            <option value="5">Viernes</option>
                            <option value="6">Sabado</option>
                            <option value="7">Domingo</option>
                        </select>

                    </div>

                    <div class="form-group">
                        <label asp-for="HoraRiego"></label>
                        <input asp-for="HoraRiego" type="time" step="1" class="form-control" required /> 
                    </div>

                    <div class="form-group">
                        <label asp-for="FrecuenciaRiego"></label>
                        <select asp-for="FrecuenciaRiego" type="number" class="form-control" required>
                            <option value="">Seleccione frecuencia diaria</option>
                            <option value="1">1 vez al dia</option>
                            <option value="2">2 veces al dia</option>
                            <option value="3">3 veces al dia</option>
                            <option value="4">4 veces al dia</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label asp-for="MetodoNotificacion"></label>
                        <select asp-for="MetodoNotificacion" class="form-control" required>
                            <option value="all">Todos (SMS + Email + Web)</option>
                            <option value="sms">Solo SMS</option>
                            <option value="email">Solo Email</option>
                            <option value="web">Solo Web</option>
                        </select>
                    </div>                    

                    <input type="hidden" asp-for="EstadoNotificacion" value="true" />
                </div>

                <button type="submit" class="btn-primary" style="margin-top: 20px;">
                    💾 Guardar Calendario de Riego
                </button>
            </form>

        </div>

        <!-- Lista de Riegos -->
        <div class="calendar-section" style="margin-top: 30px;">
            <h2 style="color: #764ba2; margin-bottom: 20px;">📋 Riegos Programados</h2>
            <div class="schedule-list" id="scheduleList"></div>
        </div>

        
    </div>

    <!-- SCRIPT COMPLETO (AJUSTADO PARA CARGAR DATOS DEL SERVIDOR) -->
    <script>
        // array que contendrá los calendarios traídos del servidor
        let wateringSchedules = [];

        // transforma la hora "HH:mm:ss" o "HH:mm" a "HH:mm"
        function formatTime(timestr) {
            if (!timestr) return '';
            const parts = timestr.split(':');
            return parts.length >= 2 ? `${parts[0].padStart(2,'0')}:${parts[1].padStart(2,'0')}` : timestr;
        }

        // Función que carga los calendarios desde el servidor
        async function loadSchedulesFromServer() {
            try {
                const res = await fetch('@Url.Action("MostrarCalendario","CalendarioRiego")', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                const data = await res.json();

                
                if (data && data.success === false && data.data) {
                    wateringSchedules = data.data.map(mapServerToClient);
                } else {
                    
                    wateringSchedules = (Array.isArray(data) ? data : []).map(mapServerToClient);
                }

                renderScheduleList();
                renderTodayWatering();
            } catch (err) {
                console.error('Error cargando calendarios:', err);
            }
        }

        // Funcion para mapear los datos del servidor
        function mapServerToClient(item) {
            return {
                id: item.idCalendarioRiego ?? item.id,
                plantName: item.nombreOrquidea ?? item.plantName,
                zone: item.zona ?? item.zone,
                day: item.diaRiego ?? item.day,
                time: formatTime(item.horaRiego ?? item.time),
                frequency: item.frecuenciaRiego ?? item.frequency,
                notificationMethod: item.metodoNotificacion ?? item.notificationMethod,
                active: item.estadoNotificacion ?? item.active
            };
        }

       

        // Funcion eliminar Alerta
        function deleteSchedule(id) {
            if (!id) return;
            if (!confirm('¿Está seguro de eliminar este calendario de riego?')) return;

            const actionUrl = '@Url.Action("BorrarAlerta","CalendarioRiego")';
                
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const tokenValue = tokenInput ? tokenInput.value : '';
                        
            const form = document.createElement('form');
            form.method = 'post';
            form.action = actionUrl;
            form.style.display = 'none';

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = id;
            form.appendChild(idInput);

            if (tokenValue) {
                const tokenField = document.createElement('input');
                tokenField.type = 'hidden';
                tokenField.name = '__RequestVerificationToken';
                tokenField.value = tokenValue;
                form.appendChild(tokenField);
            }

            document.body.appendChild(form);
            form.submit(); 
        }

        
        function toggleSchedule(id) {
            if (!id) return;
            const schedule = wateringSchedules.find(s => String(s.id) === String(id));
            if (!schedule) return;

            const newState = !schedule.active;
            const actionUrl = '@Url.Action("CambiarEstadoNotificacion","CalendarioRiego")';
                       
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const tokenValue = tokenInput ? tokenInput.value : '';
                        
            const form = document.createElement('form');
            form.method = 'post';
            form.action = actionUrl;
            form.style.display = 'none';

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'IdCalendarioRiego';
            idInput.value = id;
            form.appendChild(idInput);

            const stateInput = document.createElement('input');
            stateInput.type = 'hidden';
            stateInput.name = 'EstadoNotificacion';
            stateInput.value = newState ? 'true' : 'false';
            form.appendChild(stateInput);

            if (tokenValue) {
                const tokenField = document.createElement('input');
                tokenField.type = 'hidden';
                tokenField.name = '__RequestVerificationToken';
                tokenField.value = tokenValue;
                form.appendChild(tokenField);
            }

            document.body.appendChild(form);
            form.submit(); 
        }

        // Funcion Obtener iconos
        function getNotificationIcon(method) {
            const icons = {
                'all': '📱📧🌐',
                'sms': '📱',
                'email': '📧',
                'web': '🌐'
            };
            return icons[method] || '🔔';
        }

        // Funcion Obtener frecuencia en texto
        function getFrequencyText(freq) {
            const texts = {
                1: '1 vez al dia',
                2: '2 veces al dia',
                3: '3 veces al dia',
                4: '4 veces al dia'
            };
            return texts[freq] || freq;
        }

        // Funcion Obtener dia en texto
        function getDayText(day) {
            const texts = {
                1: 'Lunes',
                2: 'Martes',
                3: 'Miercoles',
                4: 'Jueves',
                5: 'Viernes',
                6: 'Sabado',
                7: 'Domingo'
            };
            return texts[day] || day;
        }

        // Funcion renderizar lista de riegos
        function renderScheduleList() {
            const container = document.getElementById('scheduleList');

            if (!wateringSchedules || wateringSchedules.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;">No hay calendarios programados</p>';
                return;
            }

            container.innerHTML = wateringSchedules.map(schedule => `
                <div class="schedule-item ${schedule.active ? 'active' : ''}" style="${!schedule.active ? 'opacity:0.6;' : ''}">
                    <div style="flex:1;">
                        <h3 style="margin-bottom:8px;color:#764ba2;">
                            💧 ${schedule.plantName}
                            <span style="background:#667eea;color:white;padding:4px 10px;border-radius:15px;font-size:12px;margin-left:10px;">
                                Zona ${schedule.zone}
                            </span>
                        </h3>
                        <div style="display:flex;gap:20px;flex-wrap:wrap;font-size:14px;color:#666;">
                            <span>📅 ${getDayText(schedule.day)}</span>
                            <span>🕐 ${schedule.time}</span>
                            <span>🔄 ${getFrequencyText(schedule.frequency)}</span>
                            <span>🔔 ${getNotificationIcon(schedule.notificationMethod)}</span>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <button onclick="toggleSchedule(${schedule.id})"
                                style="padding:8px 15px;background:${schedule.active ? '#ffa502' : '#26de81'};color:white;border:none;border-radius:6px;cursor:pointer;">
                            ${schedule.active ? '⏸️ Pausar' : '▶️ Activar'}
                        </button>
                        <button onclick="deleteSchedule(${schedule.id})" class="btn-delete">
                            🗑️ Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Funcion renderizar riegos de hoy
        function renderTodayWatering() {
            let today = new Date().getDay();
            if (today === 0) today = 7;
            const todaySchedules = (wateringSchedules || []).filter(s => s.day === today && s.active);
            const container = document.getElementById('todayWatering');

            if (todaySchedules.length === 0) {
                container.innerHTML =
                    '<p style="text-align:center;color:#666;padding:20px;background:#f8f9fa;border-radius:10px;">No hay riegos programados para hoy</p>';
                return;
            }

            container.innerHTML = todaySchedules.map(schedule => `
                <div style="padding:20px;background:#e6fff0;border-radius:10px;margin-bottom:15px;border-left:4px solid #26de81;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h3 style="color:#155724;margin-bottom:5px;">💧 ${schedule.plantName}</h3>
                            <p style="color:#666;margin:0;">Hora programada: <strong>${schedule.time}</strong> | Zona ${schedule.zone}</p>
                        </div>
                        <span style="padding:10px 20px;background:#26de81;color:white;border-radius:20px;font-weight:bold;">
                            ⏰ HOY
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // Funcion mostrar notificaciones
        function showNotification(message, type) {
            const container = document.getElementById('wateringNotifications');
            const notifDiv = document.createElement('div');
            notifDiv.className = `notification-item ${type}`;

            notifDiv.innerHTML = `
                <div>
                    <strong>${message}</strong>
                    <div class="notification-channels">
                        <span>📧 Email</span>
                        <span>📱 SMS</span>
                        <span>🌐 Web</span>
                    </div>
                </div>
                <small style="color:#666;">${new Date().toLocaleTimeString()}</small>
            `;

            container.insertBefore(notifDiv, container.firstChild);
            if (container.children.length > 3) container.removeChild(container.lastChild);
        }


        document.addEventListener('DOMContentLoaded', () => {
            
            loadSchedulesFromServer();

            
            const today = new Date().getDay();
            const d = document.getElementById('wateringDay');
            if (d) d.value = today;
            showNotification('📅 Sistema de calendario activo - Monitoreando riegos programados', 'success');
        });

        // ⬇️⬇️⬇️ SCRIPT DEL LOADER ⬇️⬇️⬇️
        window.addEventListener("load", () => {
            const loader = document.getElementById("loader");
            loader.classList.add("fade-out");

            setTimeout(() => {
                loader.style.display = "none";
            }, 500);
        });
        // ⬆️⬆️⬆️ FIN SCRIPT LOADER ⬆️⬆️⬆️

    </script>

</body>
</html>
