@{
    ViewData["Title"] = "Monitor de Temperatura - OrchidCare";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/css/site.css">
</head>

<body class="temperature-background">

    @Html.AntiForgeryToken()

    <!--  LOADER - Opción 3: Flor girando  -->
    <div id="loader">
        <div class="loader-icon">
            🌸
        </div>
    </div>
    <!--  FIN LOADER -->
    <!-- TOPBAR TEMPERATURA -->
    <div class="topbar-temperature">
        <div class="topbar-left">
            <span class="top-icon">🌡️</span>
            <h2 class="top-title">Monitor de Temperatura Ambiental</h2>
        </div>

        <button class="topbar-btn"
                onclick="location.href='@Url.Action("Dashboard", "Home")'">
            ← Volver al Menú Principal
        </button>
    </div>


    <!-- CONTENIDO -->
    <div class="dashboard">

        <!-- Información del rango óptimo -->
        <div class="sensor-container">
            <h3 style="color:#764ba2; margin-bottom:10px;">ℹ️ Rango Óptimo de Temperatura</h3>
            <div style="display:flex; gap:30px; flex-wrap:wrap;">
                <div><strong>🌙 Noche:</strong> 18°C - 20°C</div>
                <div><strong>☀️ Día:</strong> 22°C - 24°C</div>
                <div><strong>💧 Humedad Relativa:</strong> ~80%</div>
            </div>
        </div>

        <!-- Sensores -->
        <div class="sensor-container">
            <div class="sensor-header">
                <h2 style="color:#764ba2;">📡 Sensores de Temperatura - Tiempo Real</h2>
                <button onclick="location.reload()" class="btn-primary">🔄 Actualizar</button>
            </div>

            <div class="sensor-grid">
                <div class="sensor-card temperature-card">
                    <div class="sensor-label">Invernadero Principal</div>
                    <div class="sensor-value" id="temp1">--</div>
                    <div class="sensor-status" id="tempStatus1">Conectando...</div>
                    <small style="opacity:.8;margin-top:10px;display:block;">Zona A - B - C - Plantines</small>
                </div>


                <div class="sensor-card temperature-card">
                    <div class="sensor-label">Exterior (Referencia)</div>
                    <div class="sensor-value" id="temp2">--</div>
                    <div class="sensor-status" id="tempStatus2">Conectando...</div>
                    <small style="opacity:.8;margin-top:10px;display:block;">Temperatura ambiente</small>
                </div>
            </div>

            <div id="temperatureAlerts" style="margin-top:20px;"></div>
           
        </div>

        <!-- Gráfico Simulado 
        <div class="sensor-container">
            <h2 style="color:#764ba2;margin-bottom:20px;">📈 Variación de Temperatura - Últimas 24 Horas</h2>
            <div style="background:#f8f9fa;padding:30px;border-radius:10px;">
                <div id="tempChart"
                     style="display:flex;justify-content:space-around;align-items:flex-end;height:200px;"></div>
                <div style="display:flex;justify-content:space-around;margin-top:10px;font-size:12px;color:#666;">
                    <span>00:00</span><span>04:00</span><span>08:00</span><span>12:00</span>
                    <span>16:00</span><span>20:00</span><span>24:00</span>
                </div>
            </div>
        </div>
        -->
        <!-- Historial -->
        <div class="sensor-container">
            <h2 style="color:#764ba2;margin-bottom:20px;">📊 Registro de Lecturas</h2>
            <div class="scroll-limited">
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr style="background:#f8f9fa;">
                            <th style="padding:12px;border-bottom:2px solid #dee2e6;">Fecha</th>
                            <th style="padding:12px;border-bottom:2px solid #dee2e6;">Hora</th>
                            <th style="padding:12px;border-bottom:2px solid #dee2e6;">Ubicación</th>
                            <th style="padding:12px;border-bottom:2px solid #dee2e6;">Temperatura</th>
                            <th style="padding:12px;border-bottom:2px solid #dee2e6;">Período</th>
                            <th style="padding:12px;border-bottom:2px solid #dee2e6;">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tempHistoryTable"></tbody>
                </table>
            </div>
        </div>

    </div> <!-- END DASHBOARD -->

    
    <script>
        const locations = ['Invernadero Principal', 'Exterior'];
        let temps=[];
        let historialTA=[];

        // Envia un POST por sensor al controlador con antiforgery token
        async function postAgregarDatosSensorEHistorial(idSensor, temperature, date, time, periodo, estado) {
            try {
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                const token = tokenInput ? tokenInput.value : '';

                const res = await fetch('@Url.Action("AgregarDatosSensorEHistorialTA", "TemperaturaAmbiente")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: new URLSearchParams({
                        '__RequestVerificationToken': token,
                        'idSensor': idSensor,
                        'temperature': temperature,
                        'date' : date,
                        'time' : time,
                        'periodo' : periodo,
                        'estado' : estado
                    })
                });

                if (!res.ok) throw new Error('Respuesta no OK: ' + res.status);
                const json = await res.json();
                return json;
            } catch (err) {
                console.error('Error en postAgregarDatosSensor:', err);
                return { success: false, message: err.message };
            }
        }

        function updateTemperatureSensors() {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const timeStr = now.toTimeString().split(' ')[0];
            const hour = now.getHours();
            const period = (hour >= 6 && hour < 18) ? 'Día' : 'Noche';
            const optimal = period === 'Día' ? { min: 22, max: 24 } : { min: 18, max: 20 };
            const alerts = [];


            temps[1]=Math.random() * 8 + 15;
            temps[2]=Math.random() * 8 + 15;
            temps[3]=Math.random() * 8 + 15;
            temps[4]=Math.random() * 8 + 15;
            temps[5]=Math.random() * 15 + 15;

            let statusT;
            let status;
            let suma = 0;
            for (let i = 1; i <= 4; i++) {
                
                suma += temps[i];
            }
            let promedio = parseFloat((suma / 4).toFixed(1));
            
            document.getElementById(`temp1`).textContent = promedio + '°C';

            if (promedio >= optimal.min && promedio <= optimal.max) {
                statusT = `✅ Óptimo para ${period}`;
                status = "Optimo";
            } else if (promedio < optimal.min) {
                statusT = `❄️ Frío (${period})`;
                status = "Frio";
                alerts.push(`${locations[1]}: Baja (${promedio}°C)`);
            } else {
                statusT = `🔥 Caliente (${period})`;
                status = "Caliente";
                alerts.push(`${locations[1]}: Alta (${promedio}°C)`);
            }
            document.getElementById(`tempStatus${1}`).textContent = statusT;

            document.getElementById(`temp${2}`).textContent = temps[5].toFixed(1) + '°C';
            document.getElementById(`tempStatus${2}`).textContent = "📊 Referencia";

            // enviar todas las peticiones y esperar a que terminen antes de pedir historial
            const promises = [];
            for(let i=1; i <=5 ; i++){
                const estadoToSend = (i === 5) ? "Referencia" : status;
                promises.push(postAgregarDatosSensorEHistorial(i, temps[i].toFixed(1), date, timeStr, period, estadoToSend));
            }

            Promise.all(promises)
                .then(() => getHistorialTA())
                .catch(err => {
                    console.error('Error en envíos de sensores:', err);
                    // igualmente intentar actualizar historial
                    getHistorialTA();
                });

            displayAlerts(alerts);
        }

        function displayAlerts(alerts) {
            const c = document.getElementById("temperatureAlerts");
            if (alerts.length === 0) {
                c.innerHTML = `
                    <div style="background:#e6fff0;padding:15px;border-radius:10px;border-left:4px solid #26de81;">
                        <strong style="color:#155724;">✔ Todas las temperaturas están en rango óptimo</strong>
                    </div>`;
            } else {
                c.innerHTML = `
                    <div style="background:#fff3cd;padding:15px;border-radius:10px;border-left:4px solid #ffc107;">
                        <strong style="color:#856404;">⚠ Alertas:</strong>
                        ${alerts.map(a => `<div>• ${a}</div>`).join("")}
                    </div>`;
            }
        }

        // Recupera historial desde MostrarHistorial y lo mapea
        async function getHistorialTA() {
            try {
                const res = await fetch('@Url.Action("MostrarHistorial", "TemperaturaAmbiente")', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                if (!res.ok) throw new Error('Respuesta no OK: ' + res.status);
                const data = await res.json();

                console.debug('[addHistory] respuesta cruda:', data);

                let raw = [];
                if (Array.isArray(data)) raw = data;
                else if (data && Array.isArray(data.data)) raw = data.data;
                else if (data && Array.isArray(data.list)) raw = data.list;
                else raw = [];


                if (raw.length > 0) console.debug('[addHistory] primer item raw:', raw[0]);

                historialTA = raw.map(mapServerToClient).reverse().slice(0, 50);
                console.log(raw);
                
            } catch (err) {
                console.error('Error cargando historialTA:', err);
                historialTA = [];
            }

            renderHistoryList();
        }

        function renderHistoryList() {
            const container = document.getElementById('tempHistoryTable');
            if (!Array.isArray(historialTA) || historialTA.length === 0) {
                container.innerHTML = '<tr><td colspan="6" class="history-empty">No hay Historial disponible</td></tr>';
                return;
            }

            container.innerHTML = historialTA.map(h => `
                <tr>
                    <td style="padding:12px;">${h.date}</td>
                    <td style="padding:12px;">${h.time}</td>
                    <td style="padding:12px;">${h.sensorId === 5 ? locations[1] : locations[0]}</td>
                    <td style="padding:12px;"><strong>${h.temperatura} ºC</strong></td>
                    <td style="padding:12px;">${h.period}</td>
                    <td style="padding:12px;">${h.status}</td>
                </tr>
            `).join('');
            console.debug(`renderHistoryList: renderizados ${historialTA.length} registros`);
        }

        // Adaptarlo Cuando haya tiempo
        function createTempChart() {
            const chart = document.getElementById("tempChart");
            let html = "";
            for (let i = 0; i < 7; i++) {
                const temp = Math.random() * 6 + 18;
                const height = (temp / 30) * 100;
                const color = temp >= 18 && temp <= 24 ? "#26de81" : "#ffa502";

                html += `
                <div style="flex:1;text-align:center;">
                    <small>${temp.toFixed(1)}°C</small>
                    <div style="width:40px;height:${height}%;background:${color};border-radius:5px 5px 0 0;"></div>
                </div>`;
            }
            chart.innerHTML = html;
        }

        function mapServerToClient(item) {
            try {
                const idRegistro = item.IdRegistroHistoricoTA ?? item.idRegistroHistoricoTA ?? item.IdRegistro ?? item.id ?? null;
                const idValores = item.IdValoresSensor ?? item.idValoresSensor ?? null;

                const vs = item.valoresSensor ?? item.ValoresSensor ?? item.Valores ?? null;

                const tempRaw = item.temperatura ?? item.temperature ?? (vs ? (vs.Temperatura ?? vs.temperatura) : null);
                const temperature = (tempRaw === null || tempRaw === undefined) ? null : parseFloat(tempRaw);


                const sensorId = (vs && (vs.IdSensor ?? vs.id ?? vs.idSensor)) ?? item.IdSensor ?? item.idSensor ?? item.SensorId ?? null;

                let date = item.Fecha ?? item.fecha ?? item.date ?? item.Date ?? null;
                let time = item.Hora ?? item.hora ?? item.time ?? item.Time ?? null;

                if (date.includes('T')) {
                    date = date.split('T')[0];
                }

                if (date && typeof date === 'string' && !time) {
                    const d = new Date(date);
                    if (!isNaN(d)) {
                        date = d.toLocaleDateString();
                        time = d.toLocaleTimeString();
                    }
                }

                const now = new Date();
                date = date ?? now.toLocaleDateString();
                time = time ?? now.toLocaleTimeString();

                let period = item.Periodo ?? item.periodo ?? item.Period ?? null;
                if (!period) {
                    let hour = now.getHours();
                    if (typeof time === 'string') {
                        const parts = time.split(':');
                        const h = parseInt(parts[0], 10);
                        if (!isNaN(h)) hour = h;
                    }
                    period = (hour >= 6 && hour < 18) ? 'Día' : 'Noche';
                }

                let status = item.status ?? item.estado ?? item.Estado ?? null;
                
                if (!status) {
                    
                    if (temperature !== null && !isNaN(temperature)) {
                        const bounds = (period === 'Día') ? { min: 22, max: 24 } : { min: 18, max: 20 };
                        if (temperature >= bounds.min && temperature <= bounds.max) status = `✅ Óptimo`;
                        else if (temperature < bounds.min) status = `❄️ Frío (${period})`;
                        else status = `🔥 Caliente (${period})`;
                    } else {
                        status = '⏳ Sin datos';
                    }
                }

                return {
                    idRegistro,
                    idValores,
                    sensorId: sensorId ?? '--',
                    temperatura: (temperature !== null && !isNaN(temperature)) ? temperature.toFixed(1) : '--',
                    date,
                    time,
                    period,
                    status
                };
            } catch (err) {
                console.error('mapServerToClient error:', err, item);
                return {
                    idRegistro: null,
                    idValores: null,
                    sensorId: '--',
                    temperatura: '--',
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    period: 'N/D',
                    status: '⏳ Sin datos'
                };
            }
        }

        setInterval(updateTemperatureSensors, 5000);
        updateTemperatureSensors();
        //createTempChart();

        // LOADER
        window.addEventListener("load", () => {
            const loader = document.getElementById("loader");
            loader.classList.add("fade-out");

            setTimeout(() => {
                loader.style.display = "none";
            }, 500);
        });
    </script>

</body>
</html>
